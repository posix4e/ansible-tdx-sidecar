---
# Wait for TDX VM to be ready

- name: Wait for VM to be in running state
  ansible.builtin.command:
    cmd: virsh domstate {{ vm_name }}
  register: vm_state
  until: vm_state.stdout | trim == 'running'
  retries: 30
  delay: 5
  changed_when: false

- name: Wait for VM to boot (initial delay)
  ansible.builtin.pause:
    seconds: 60
  when: true

- name: Check if application is running
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ app_port }}{{ app_health_check_path | default('/') }}"
    method: GET
    timeout: 10
    follow_redirects: none
    status_code: [200, 301, 302, 308]
  register: app_check
  until: app_check.status in [200, 301, 302, 308]
  retries: 60
  delay: 5
  failed_when: false

- name: Display application status
  ansible.builtin.debug:
    msg: "Application: {{ 'Running' if app_check.status | default(0) in [200, 301, 302, 308] else 'Not ready - status ' + (app_check.status | default('unknown') | string) }}"

- name: Get VM serial log if app not ready
  ansible.builtin.command:
    cmd: tail -50 /var/log/libvirt/qemu/{{ vm_name }}-serial.log
  register: app_fail_log
  ignore_errors: true
  when: app_check.status | default(0) not in [200, 301, 302, 308]

- name: Display VM log if app not ready
  ansible.builtin.debug:
    msg: "{{ app_fail_log.stdout_lines | default(['No log available']) }}"
  when: app_check.status | default(0) not in [200, 301, 302, 308]

- name: Check TDX attestation proxy status
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ tdx_proxy_host_port | default(8082) }}/status"
    method: GET
    timeout: 10
  register: tdx_status
  failed_when: false
  when: tdx_enabled | default(true)

- name: Display TDX status
  ansible.builtin.debug:
    msg: "TDX Proxy: {{ tdx_status.json | default({'available': 'unknown'}) }}"
  when: tdx_enabled | default(true) and tdx_status.status | default(0) == 200
