#cloud-config
# Cloud-init configuration for TDX Application VM

hostname: {{ vm_name }}

ssh_pwauth: true

users:
  - name: {{ guest_user }}
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
{% if guest_ssh_authorized_key %}
    ssh_authorized_keys:
      - {{ guest_ssh_authorized_key }}
{% endif %}

chpasswd:
  expire: false
  users:
    - name: {{ guest_user }}
      password: {{ guest_password }}
      type: text

# Add TDX attestation PPA for quote generation support
apt:
  sources:
    tdx-attestation:
      source: "ppa:kobuk-team/tdx-attestation-release"

# Run apt-get update and upgrade before installing packages
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose-v2
  - libtdx-attest
  - libtdx-attest-dev

write_files:
  - path: /opt/app/tdx-attestation-proxy.py
    permissions: '0755'
    content: |
{{ lookup('file', role_path + '/files/tdx-attestation-proxy.py') | indent(6, first=True) }}

  - path: /etc/systemd/system/tdx-attestation-proxy.service
    permissions: '0644'
    content: |
      [Unit]
      Description=TDX Attestation Proxy
      After=network.target

      [Service]
      Type=simple
      ExecStart=/usr/bin/python3 /opt/app/tdx-attestation-proxy.py
      Restart=always

      [Install]
      WantedBy=multi-user.target

  - path: /opt/app/docker-compose.yml
    permissions: '0644'
    content: |
{{ lookup('template', 'docker-compose.yml.j2') | indent(6, first=True) }}

  - path: /etc/systemd/system/app.service
    permissions: '0644'
    content: |
      [Unit]
      Description=Application Stack
      After=docker.service
      Requires=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/app
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down

      [Install]
      WantedBy=multi-user.target

runcmd:
  # Install linux-modules-extra for TDX configfs-tsm support
  - apt-get install -y linux-modules-extra-$(uname -r) || true
  # Reload systemd to pick up new service files
  - systemctl daemon-reload
  # Start TDX attestation proxy
  - systemctl enable tdx-attestation-proxy
  - systemctl start tdx-attestation-proxy
  # Ensure docker is running and wait for it to be ready
  - systemctl enable docker
  - systemctl start docker
  - sleep 5
  - docker info > /dev/null 2>&1 || sleep 10
  # Pull application image (retry on failure)
  - docker pull {{ app_image }} || sleep 30 && docker pull {{ app_image }} || true
  # Start application stack
  - systemctl enable app
  - systemctl start app || sleep 10 && systemctl start app || true

final_message: |
  TDX Application VM is ready!

  TDX Attestation Proxy: http://localhost:8081
  Application: http://localhost:{{ app_container_port | default(app_port) }}
{% if enable_minio | default(false) %}
  Minio Console: http://localhost:9001
{% endif %}

  To check TDX status: curl http://localhost:8081/status
  To get TDX quote: curl http://localhost:8081/quote
